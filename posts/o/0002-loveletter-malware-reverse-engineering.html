<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
        <title>Malware/  Loveletter - Reverse engineering</title>

        <meta name="theme-color" content="#252525">

	<link href="https://fonts.googleapis.com/css?family=Amiri" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono:100,300,400" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700|Open+Sans:300,400,600|Raleway:200,300,400,600&amp;subset=latin-ext" rel="stylesheet">

        <link rel="stylesheet" href="assets/css/normalize.css">
        <link rel="stylesheet" href="assets/css/skeleton.css">
        <link rel="stylesheet" href="assets/css/home.css">

    </head>
    <body>

        <div class="container" style="margin-top: 30px;">

            <div class="row">
                <p style="text-align:center;">
                    <img src="assets/img/duraki-logo.png" alt="duraki logo"/>
                </p>
            </div>

	    <div class="row">
                <div class="one-sixth column" style="margin-top: 10%; margin-left: 0%";>
                    <h3><a href="/">blog</a> / <a href="">Malware/  Loveletter - Reverse engineering</a></h3>
                </div>
	    </div>

            <div class="tags">
            <code class="tags-code">malware</code>
            <code class="tags-code">loveletter</code>
            <code class="tags-code">trojan</code>
            <code class="tags-code">dropper</code>
            <code class="tags-code">reverse</code>
            <code class="tags-code">analysis</code>
            </div>

	    <hr style="display: block; text-align: left; width: 100%;" />

            <div class="row">
                <div class="six columns" style="margin-top: 0%;"><h2 id="intro"><a class="header-link" href="#intro"></a>Intro</h2>
<p>Završen je moj crawler koji vrši monitor na malware sample stranicama i ufatio &quot;bruku&quot; malware-a. Neki dan sam reversao ovaj ali mi je bilo mrsko postaviti neki tekst o njemu. Sutra imam obaveza pa ću danas da postavim, a ako ne postavim danas neću nikad.. Pa da počnemo :)  </p>
<p>EDIT: Postavljena geturls skripta. Pozdrav tr3x. </p>
<h2 id="info"><a class="header-link" href="#info"></a>Info</h2>
<pre class="hljs"><code><span class="hljs-attribute">MD5</span>: 4a15a452bc958a92d25c3b4103041e65
<span class="hljs-attribute">SHA</span>: 27dfd06eb5d78ba1d52bef58336788d8ebaad0dfe75b468e91ab07277785ba8e

<span class="groovy"><span class="hljs-string">Filename:</span> <span class="hljs-number">4</span>a15a452bc958a92d25c3b4103041e65.exe
<span class="hljs-string">Honeypot:</span> Remote
Detection <span class="hljs-string">ratio:</span> <span class="hljs-number">25</span> / <span class="hljs-number">47</span></span></code></pre><p>Datoteka je inače bila pakirana u setup arhivu, peID detektovao Inno Setup paker. Kažu ne može se unpakovati, a ja kao ono, ma daj ljudi jeste li normalni. Prvi link baca unpaker koji je pisao QuickeneR. Sljedeći korak - unpakirati fajl.</p>
<pre class="hljs"><code>&gt; <span class="hljs-selector-tag">innounp</span><span class="hljs-selector-class">.exe</span> <span class="hljs-selector-tag">-x</span> 4<span class="hljs-selector-tag">a15a452bc958a92d25c3b4103041e65</span><span class="hljs-selector-class">.exe</span>

17<span class="hljs-selector-class">.07</span><span class="hljs-selector-class">.2011</span>  15<span class="hljs-selector-pseudo">:18</span>                 0 <span class="hljs-selector-tag">License</span><span class="hljs-selector-class">.txt</span>
20<span class="hljs-selector-class">.06</span><span class="hljs-selector-class">.2012</span>  13<span class="hljs-selector-pseudo">:20</span>           208<span class="hljs-selector-class">.896</span> <span class="hljs-selector-tag">LoveLetter</span><span class="hljs-selector-class">.exe</span>
15<span class="hljs-selector-class">.06</span><span class="hljs-selector-class">.2012</span>  23<span class="hljs-selector-pseudo">:42</span>               233 <span class="hljs-selector-tag">Readme</span><span class="hljs-selector-class">.txt</span>
31<span class="hljs-selector-class">.07</span><span class="hljs-selector-class">.2000</span>  11<span class="hljs-selector-pseudo">:52</span>            19<span class="hljs-selector-class">.393</span> <span class="hljs-selector-tag">Why</span><span class="hljs-selector-class">.mid</span></code></pre><p>To su &quot;ostaci&quot; unpakinga. <em>LoveLetter.exe</em> izgleda najzanimljivije ovdje pa da vidimo šta se krije tu. Ispod je objašnjenje fajlova.</p>
<pre class="hljs"><code>License<span class="hljs-selector-class">.txt</span>         <span class="hljs-comment">// Ludi kinezi, prazan fajl</span>
LoveLetter<span class="hljs-selector-class">.exe</span>         <span class="hljs-comment">// Gore rečeno, malware sample</span>
Readme<span class="hljs-selector-class">.txt</span>             <span class="hljs-comment">// Nešta na kineskom</span>
Why<span class="hljs-selector-class">.mid</span>             <span class="hljs-comment">// Ne želite znati</span></code></pre><h2 id="run-the-linux-!!"><a class="header-link" href="#run-the-linux-!!"></a>Run the Linux !!</h2>
<pre class="hljs"><code>$ packer LoveLetter<span class="hljs-selector-class">.exe</span>
Microsoft Visual Basic <span class="hljs-number">5.0</span> / <span class="hljs-number">6.0</span>

$ md5sum LoveLetter<span class="hljs-selector-class">.exe</span>
<span class="hljs-number">2</span>e62536f2b417c5f2cc88b321bee997c</code></pre><p>Ok! :# Ajmo skenirati &quot;LoveLetter&quot; na VT. Čino mi se da je UD čim je na new-list malware pa da vidimo šta kaže VirusTotal. Završenim skeniranjem, detection rate je 10/46. Malware postavlja registry ključ za automatsko pokretanje poslije boot-a koristeći se WinAPIom RegCreateKey(Ex).</p>
<pre class="hljs"><code>HKLM<span class="hljs-symbol">\S</span>OFTWARE<span class="hljs-symbol">\M</span>icrosoft<span class="hljs-symbol">\W</span>indows<span class="hljs-symbol">\C</span>urrentVersion<span class="hljs-symbol">\R</span>un<span class="hljs-symbol">\l</span>oveletter</code></pre><p class="img-container"><img src="http://i.imgur.com/JL18Exx.png" alt="Registry Loveletter"></p>
<h2 id="sniff,-sniff-:)"><a class="header-link" href="#sniff,-sniff-:)"></a>Sniff, sniff :)</h2>
<p>Kad malo bolje pogledam, možda bi bilo interesantno vidjeti kakve requeste radi. Pokrenem malware, vidim da se veže na remote IP/hostname (process explorer huh).</p>
<p class="img-container"><img src="http://i.imgur.com/twDcmA7.png" alt="Inside of sniffing"></p>
<p>Olly naravno otkriva više nego dovoljno detalja ali sam trenutno na Linux mašini. Ispisao sam bash skriptu koja koristi grep uz parametar za binary fajl i traži http:// i www stringove. Mislim da svaki korisnik Linuxa to može ispisati tako da vam ne treba skripta (recimo).  </p>
<pre class="hljs"><code>$ ./geturls LoveLetter.exe
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://hi.baidu.com/ietrtg"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://url.gouwuke.cn/id/1"</span> = DEAD
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://www.haoda123.com"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://www.baidu.com/baidu?tn=flstudios_cb&amp;word={searchTerms}&amp;cl=3&amp;ie=utf-8"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://www.87265.com"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://www.9365.info"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://adsvc1.unadnet.com.cn/ad/softad/popup.htm"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://adsvc1.unadnet.com.cn/count/softcount/?LoveLetter"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://adsvc1.unadnet.com.cn/ad/softad/tuijian.htm"</span>
 <span class="hljs-keyword">Text</span> <span class="hljs-built_in">string</span> HUE= <span class="hljs-string">"http://%61%64%73%76%63%31%2E%39%33%36%35%2E%69%6E%66%6F/ad/softad/pwc.htm"</span></code></pre><p>Pri samoj eksekuciji spaja se na remote (z11.cnzz.com), a cnzz.com je kineski provajder za cloud hosting i analizu korisnika uz posebne parametre. Ispod je slika i request za spajanje koji sam snifao.</p>
<pre class="hljs"><code><span class="hljs-symbol">5 </span>   TCP    <span class="hljs-number">192.168.1.175</span>    <span class="hljs-number">42.156.140.24</span>    <span class="hljs-number">3065</span>    <span class="hljs-number">80</span>        z11.cnzz.<span class="hljs-keyword">com</span>    http    <span class="hljs-number">7</span>    <span class="hljs-number">655</span> Bytes    <span class="hljs-number">1</span>,<span class="hljs-number">425</span> Bytes    <span class="hljs-number">1.1</span> KB/Sec    <span class="hljs-number">12</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">35</span>:<span class="hljs-number">58</span> AM:<span class="hljs-number">544</span>    <span class="hljs-number">12</span>/<span class="hljs-number">26</span>/<span class="hljs-number">2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">35</span>:<span class="hljs-number">59</span> AM:<span class="hljs-number">115</span>    <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00.570</span>        </code></pre><h1 id="request:"><a class="header-link" href="#request:"></a>Request:</h1>
<pre class="hljs"><code>GET /stat.htm?id=<span class="hljs-number">555586</span><span class="hljs-variable">&amp;r</span>=<span class="hljs-variable">&amp;lg</span>=en-us<span class="hljs-variable">&amp;ntime</span>=<span class="hljs-number">1388027462</span><span class="hljs-variable">&amp;repeatip</span>=<span class="hljs-number">1</span><span class="hljs-variable">&amp;rtime</span>=<span class="hljs-number">0</span><span class="hljs-variable">&amp;cnzz_eid</span>=<span class="hljs-number">1364475466</span><span class="hljs-number">-1388027462</span>-<span class="hljs-variable">&amp;showp</span>=<span class="hljs-number">1152</span>x776<span class="hljs-variable">&amp;st</span>=<span class="hljs-number">1495</span><span class="hljs-variable">&amp;sin</span>=<span class="hljs-variable">&amp;t</span>=<span class="hljs-variable">&amp;rnd</span>=<span class="hljs-number">1229355078</span> HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Accept:</span> *<span class="hljs-comment">/*
Referer: http://adsvc1.unadnet.com.cn/count/softcount/?LoveLetter
Accept-Language: 
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)
Host: hzs7.cnzz.com
Connection: Keep-Alive
Cookie: cna=YqdCC09ZcxcCAbx/bf7Y29oX</span></code></pre><p class="img-container"><img src="http://i.imgur.com/LAbGlqy.png" alt="Request Info"></p>
<p> Malware šalje request i na još jednu subdomenu na istom websajtu te vršit UrlDownloadToFile sa pojedinih linkova. Ispod više detalja.</p>
<pre class="hljs"><code><span class="hljs-attribute">6    TCP    192.168.1.175    42.156.140.11    3066    80        c.split.cnzz.com    http    7    1,419 Bytes    2,118 Bytes    0.1 KB/Sec    12/26/2013 4:35:59 AM:806    12/26/2013 4:36:18 AM:562    00:00:18.755    

GET /core.php?web_id=555586&amp;t=z HTTP/1.1
Accept</span>: */*
<span class="hljs-attribute">Referer</span>: http://adsvc1.unadnet.com.cn/count/softcount/?LoveLetter
<span class="hljs-attribute">Accept-Language</span>: bs-ba
<span class="hljs-attribute">Accept-Encoding</span>: gzip, deflate
<span class="hljs-attribute">If-Modified-Since</span>: Thu, 26 Dec 2013 03:11:16 GMT
<span class="hljs-attribute">User-Agent</span>: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1)
<span class="hljs-attribute">Host</span>: c.cnzz.com
<span class="hljs-attribute">Connection</span>: Keep-Alive
<span class="hljs-attribute">Cookie</span>: cna=YqdCC09ZcxcCAbx/bf7Y29oX</code></pre><p>Output:
<img src="http://i.imgur.com/lQdh7TB.png" alt="Output"></p>
<p><strong>UrlDownloadToFile</strong> (više o API-u <a href="http://msdn.microsoft.com/en-us/library/ie/ms775123%28v=vs.85%29.aspx">ovdje</a>):</p>
<pre class="hljs"><code><span class="hljs-number">17</span>    TCP    <span class="hljs-number">192.168.1.175</span>    <span class="hljs-number">222.217.240.28</span>    <span class="hljs-number">3100</span>    <span class="hljs-number">80</span>        xz.ieanquan.com    http    <span class="hljs-number">1</span>,<span class="hljs-number">094</span>    <span class="hljs-number">990,204</span> Bytes    <span class="hljs-number">1,034,214</span> Bytes    <span class="hljs-number">95</span>.<span class="hljs-number">1</span> KB/Sec    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">36</span>:<span class="hljs-number">56</span> AM:<span class="hljs-number">962</span>    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">37</span>:<span class="hljs-number">07</span> AM:<span class="hljs-number">072</span>    <span class="hljs-number">00:00:10.109</span>                    
-
GET /download/dianxin_silent[<span class="hljs-number">57</span>].exe HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>

<span class="hljs-number">20</span>    TCP    <span class="hljs-number">192.168.1.175</span>    <span class="hljs-number">220.181.61.212</span>    <span class="hljs-number">3117</span>    <span class="hljs-number">80</span>        allot.hd.sohu.com    http    <span class="hljs-number">7</span>    <span class="hljs-number">407</span> Bytes    <span class="hljs-number">918</span> Bytes    <span class="hljs-number">0</span>.<span class="hljs-number">7</span> KB/Sec    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">37</span>:<span class="hljs-number">02</span> AM:<span class="hljs-number">301</span>    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">37</span>:<span class="hljs-number">02</span> AM:<span class="hljs-number">835</span>    <span class="hljs-number">00</span>:<span class="hljs-number">00:00.534</span>                    
-
GET /foxd/gz?file=SohuNewPlayer.exe&amp;new=/<span class="hljs-number">229</span>/<span class="hljs-number">67</span>/w8KSsVuAsvthyDIBzRQsP1.exe HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span>

<span class="hljs-number">24</span>    TCP    <span class="hljs-number">192.168.1.175</span>    <span class="hljs-number">58.215.93.130</span>    <span class="hljs-number">3137</span>    <span class="hljs-number">80</span>            http    <span class="hljs-number">432</span>    <span class="hljs-number">388,200</span> Bytes    <span class="hljs-number">405,777</span> Bytes    <span class="hljs-number">72</span>.<span class="hljs-number">4</span> KB/Sec    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">37</span>:<span class="hljs-number">16</span> AM:<span class="hljs-number">852</span>    <span class="hljs-number">12/26/2013</span> <span class="hljs-number">4</span>:<span class="hljs-number">37</span>:<span class="hljs-number">22</span> AM:<span class="hljs-number">089</span>    <span class="hljs-number">00:00:05.237</span>                    
-
GET /<span class="hljs-number">280</span>cf9c20714744ccd17e57f66106dc700000<span class="hljs-number">00000370d38</span>/<span class="hljs-number">9291/15474</span>/setup_<span class="hljs-number">2949-14598</span>.exe HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span></code></pre><h2 id="statični-analizeri"><a class="header-link" href="#statični-analizeri"></a>Statični analizeri</h2>
<p>Malware isto pristupa sljedećim linkovima da obavi analizu korisnika koji ga je pokrenuo, samim tim i šalje request o detaljima koji su naznačeni u linkovima dole. Većina stvari nema nikakve specifične informacije. Inače radi se o jednostavnom downloaderu koji je više manje undetected.</p>
<pre class="hljs"><code>http://www.wk<span class="hljs-number">12345</span>.com:<span class="hljs-number">8080</span>/xiaocai/intf_queryAd?userName=<span class="hljs-symbol">%s</span>|guid=<span class="hljs-symbol">%s</span>|softVersion=<span class="hljs-symbol">%d</span>
http://www.wk<span class="hljs-number">12345</span>.com:<span class="hljs-number">8080</span>/xiaocai/intf_clientLoginOrout?param=<span class="hljs-symbol">%s</span>|userName=<span class="hljs-symbol">%s</span>|guid=<span class="hljs-symbol">%s</span>|softVersion=<span class="hljs-symbol">%d</span>
http://tongji.toutiao<span class="hljs-number">001</span>.com/toutiao_web_manage/getversion.php</code></pre><p>Također sam našao i panel putujući kroz linkove a nalazi se na sljedećem linku. Možda pokušam uraditi bruteforce drugi dan. Link:</p>
<pre class="hljs"><code>http:<span class="hljs-regexp">//</span>www.wk12345.com:<span class="hljs-number">8080</span><span class="hljs-regexp">/xiaocai/</span>jsp<span class="hljs-regexp">/login.jsp</span></code></pre><h2 id="zaključak"><a class="header-link" href="#zaključak"></a>Zaključak</h2>
<p>Ništa specijalno, radi se o običnom downloaderu mlweru koji vrši multi-threaded operacije. Upratio sam da ne &quot;baca&quot; request jedan po jedan već skida sve odjednom. Ostale datoteke mi nisu bile od interesa, većinom sponzor artikli i slično.</p>
<p>Pozdrav!
Evo neko me zamolio za skriptu pa da mu udovoljim :))  </p>
<pre class="hljs"><code><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment"># geturls (./geturls)</span>
<span class="hljs-comment"># skripta za malware reseaching / pretrazivanje url-ova unutar binary fajla</span>
<span class="hljs-comment"># script for malware research / searching for url-s in binary file</span>
<span class="hljs-comment"># dn5 / @dn5__ / http://dn5.ljuska.com</span>
<span class="hljs-comment"># updatejted 29.Dec.2013. zbog public releasa</span>

<span class="hljs-keyword">if</span> [ ! -n <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Enter a filename to scan"</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> <span class="hljs-variable">$1</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Searching for URI inside of"</span> <span class="hljs-variable">$1</span>
    resultHTTP=$(grep <span class="hljs-_">-a</span> <span class="hljs-string">"http://"</span> <span class="hljs-variable">$1</span>)
    resutlHTTPS=$(grep <span class="hljs-_">-a</span> <span class="hljs-string">"https://"</span> <span class="hljs-variable">$1</span>)
    resultWWW=$(grep <span class="hljs-_">-a</span> <span class="hljs-string">"www."</span> <span class="hljs-variable">$1</span>)

    <span class="hljs-comment">#HUE = Hueristic detection stringova</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$resultHTTP</span>"</span>  &gt; <span class="hljs-string">"url"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$resultHTTPS</span>"</span> &gt;&gt; <span class="hljs-string">"url"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$resultWWW</span>"</span> &gt;&gt; <span class="hljs-string">"url"</span>

    <span class="hljs-comment"># brisanje praznih linija</span>
    awk <span class="hljs-string">'NF &gt; 0'</span> url
    rm url <span class="hljs-comment">#ne treba nam viÅ¡e &lt;- moze del po potrebi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"File does not exsist"</span>
<span class="hljs-keyword">fi</span></code></pre>
                </div>
            </div>

	    <hr style="display: block; text-align: left; width: 100%;" />

            <small style="font-family: 'Amiri'; color:rgba(68, 63, 63, 0.42)">this project, script or post is written by @durakih (c) 2017 | <a style="font-size: 11px;" href="changelog.html">[changelog]</a> | <a style="font-size: 11px;" href="https://twitter.com/devil_tux">[twitter]</a></small>

        </div>

      <script type="text/javascript" src="./assets/js/ga.js"></script>
    </body>
</html>
